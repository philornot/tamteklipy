#!/bin/bash
# TamteKlipy - Uniwersalny Skrypt Deployment (Windows Git Bash + RPi)
set -e

# Wykryj ≈õrodowisko - ulepszona detekcja dla PowerShell i Git Bash
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]] || [[ "$PWD" == *"Users"*"Windows"* ]] || [[ "$PWD" == *"C:"* ]] || [[ "$PWD" == "/c/"* ]] || [[ "$PWD" == "/mnt/c/"* ]]; then
    ENV="windows"
    PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    ENV="rpi"
    PROJECT_DIR=~/tamteklipy
fi

# Parsuj argumenty
DEPLOY_BACKEND=true
DEPLOY_FRONTEND=true
SKIP_LOCAL_COMMIT=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--backend|--backend-only)
            DEPLOY_FRONTEND=false
            shift
            ;;
        -f|--frontend|--frontend-only)
            DEPLOY_BACKEND=false
            shift
            ;;
        -p|--pull-only)
            SKIP_LOCAL_COMMIT=true
            shift
            ;;
        -h|--help)
            echo "U≈ºycie: $0 [OPCJE]"
            echo ""
            echo "Opcje:"
            echo "  (brak)           Pe≈Çny deployment (backend + frontend)"
            echo "  -b, --backend    Tylko backend"
            echo "  -f, --frontend   Tylko frontend"
            echo "  -p, --pull-only  Tylko pull na RPi (bez lokalnych commit√≥w)"
            echo "  -h, --help       Poka≈º tƒô pomoc"
            exit 0
            ;;
        *)
            echo "Nieznana opcja: $1"
            echo "U≈ºyj '$0 --help' aby zobaczyƒá dostƒôpne opcje"
            exit 1
            ;;
    esac
done

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë   TamteKlipy Deployment Script        ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "üñ•Ô∏è  ≈örodowisko: $ENV"

if [ "$DEPLOY_BACKEND" = true ] && [ "$DEPLOY_FRONTEND" = true ]; then
    echo "üöÄ Tryb: Pe≈Çny deployment (backend + frontend)"
elif [ "$DEPLOY_BACKEND" = true ]; then
    echo "üîß Tryb: Tylko backend"
elif [ "$DEPLOY_FRONTEND" = true ]; then
    echo "üé® Tryb: Tylko frontend"
fi
echo ""

cd "$PROJECT_DIR"

# ============================================
# DEPLOYMENT NA WINDOWS
# ============================================
if [ "$ENV" = "windows" ]; then
    if [ "$SKIP_LOCAL_COMMIT" = true ]; then
        echo "‚è≠Ô∏è  [1/4] Pomijanie lokalnego commita (tryb pull-only)..."
        echo ""
    else
        echo "üì¶ [1/4] Commitowanie i pushowanie zmian..."

        # Sprawd≈∫ czy sƒÖ zmiany do commitowania
        if [[ -n $(git status -s) ]]; then
            read -p "üí¨ Wiadomo≈õƒá commita: " commit_msg
            git add .
            git commit -m "$commit_msg"
            git push
            echo "‚úÖ Zmiany wypchniƒôte na GitHub"
        else
            echo "‚ÑπÔ∏è  Brak zmian do commitowania"
            git push
        fi
        echo ""
    fi

    # Build i przes≈Çanie frontendu
    if [ "$DEPLOY_FRONTEND" = true ]; then
        echo "üèóÔ∏è  [2/4] Budowanie frontendu..."
        cd frontend

        # Sprawd≈∫ czy pnpm jest dostƒôpny
        if command -v pnpm &> /dev/null; then
            pnpm install
            pnpm run build
        else
            npm install
            npm run build
        fi

        echo "‚úÖ Frontend zbudowany"
        echo ""

        echo "üì§ [3/4] Przesy≈Çanie frontendu na RPi..."

        # Utw√≥rz katalog dist na RPi je≈õli nie istnieje
        ssh frpi "mkdir -p ~/tamteklipy/frontend/dist"

        # Prze≈õlij zawarto≈õƒá dist
        scp -r dist/* frpi:~/tamteklipy/frontend/dist/

        echo "‚úÖ Frontend przes≈Çany"
        echo ""

        cd ..
    else
        echo "‚è≠Ô∏è  [2/4] Pomijanie budowania frontendu..."
        echo "‚è≠Ô∏è  [3/4] Pomijanie przesy≈Çania frontendu..."
        echo ""
    fi

    # Deployment na RPi
    echo "üöÄ [4/4] Uruchamianie deploymentu na RPi..."

    if [ "$DEPLOY_BACKEND" = true ] && [ "$DEPLOY_FRONTEND" = true ]; then
        ssh frpi "cd ~/tamteklipy && bash deploy.sh"
    elif [ "$DEPLOY_BACKEND" = true ]; then
        ssh frpi "cd ~/tamteklipy && bash deploy.sh -b"
    elif [ "$DEPLOY_FRONTEND" = true ]; then
        ssh frpi "cd ~/tamteklipy && bash deploy.sh -f"
    fi

    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë   Deployment Zako≈Ñczony! üöÄ           ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "üìç Twoja aplikacja: https://www.tamteklipy.pl"
    echo ""

# ============================================
# DEPLOYMENT NA RPI
# ============================================
else
    # Git pull - zawsze, niezale≈ºnie od trybu
    echo "üì¶ [1/6] Pobieranie najnowszego kodu..."
    git pull
    echo ""

    # Deployment backendu
    if [ "$DEPLOY_BACKEND" = true ]; then
        echo "‚öôÔ∏è  [2/6] Sprawdzanie konfiguracji backendu..."
        cd backend

        if [ ! -f .env ]; then
            echo "‚ùå backend/.env NIE ZNALEZIONY!"
            echo ""
            echo "Tworzenie z szablonu..."

            cat > .env << 'EOF'
ENVIRONMENT=production
DATABASE_URL=sqlite:///./tamteklipy.db
SECRET_KEY=CHANGE_ME_$(openssl rand -hex 16)
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
STORAGE_PATH=/mnt/tamteklipy
CLIPS_PATH=/mnt/tamteklipy/clips
SCREENSHOTS_PATH=/mnt/tamteklipy/screenshots
THUMBNAILS_PATH=/mnt/tamteklipy/thumbnails
METADATA_PATH=/mnt/tamteklipy/metadata
AWARD_ICONS_PATH=/mnt/tamteklipy/award_icons
ALLOWED_ORIGINS=https://www.tamteklipy.pl,https://tamteklipy.pl
MAX_VIDEO_SIZE_MB=500
MAX_IMAGE_SIZE_MB=10
EOF

            # Wygeneruj SECRET_KEY automatycznie
            NEW_SECRET=$(openssl rand -hex 32)
            sed -i "s/CHANGE_ME_.*/$(echo $NEW_SECRET)/" .env

            echo "‚úÖ .env utworzony z automatycznie wygenerowanym SECRET_KEY"
        else
            # Sprawd≈∫ czy SECRET_KEY nie jest domy≈õlny
            if grep -q "dev-secret-key\|CHANGE_ME\|TEMPORARY" .env; then
                echo "‚ö†Ô∏è  OSTRZE≈ªENIE: U≈ºywany jest niebezpieczny SECRET_KEY!"
                echo "Generowanie nowego..."
                NEW_SECRET=$(openssl rand -hex 32)
                sed -i "s/SECRET_KEY=.*/SECRET_KEY=$NEW_SECRET/" .env
                echo "‚úÖ SECRET_KEY zaktualizowany"
            else
                echo "‚úÖ .env istnieje i wyglƒÖda dobrze"
            fi
        fi
        echo ""

        echo "üîß [3/6] Aktualizacja backendu..."
        source venv/bin/activate
        pip install -q -r requirements.txt

        # Sprawdzenie/inicjalizacja bazy danych
        if [ ! -f tamteklipy.db ]; then
            echo "üìä Tworzenie bazy danych..."
            python -c "from app.core.init_db import init_db; init_db()"

            echo ""
            echo "üë§ Nie znaleziono u≈ºytkownik√≥w. Tworzenie admina..."
            python seed_database.py --clear
            echo ""
            echo "‚úÖ Admin utworzony: philornot / HasloFilipa"
        else
            # Sprawd≈∫ czy sƒÖ jacy≈õ u≈ºytkownicy
            USER_COUNT=$(python -c "from app.core.database import SessionLocal; from app.models.user import User; db = SessionLocal(); count = db.query(User).count(); db.close(); print(count)" 2>/dev/null || echo "0")

            if [ "$USER_COUNT" -eq "0" ]; then
                echo "üë§ Baza istnieje ale jest pusta. Tworzenie admina..."
                python seed_database.py --clear
                echo "‚úÖ Admin utworzony: philornot / HasloFilipa"
            else
                echo "‚úÖ Baza OK ($USER_COUNT u≈ºytkownik√≥w)"
            fi
        fi

        sudo systemctl restart tamteklipy-backend
        echo "‚úÖ Backend zrestartowany"
        echo ""

        cd ..
    else
        echo "‚è≠Ô∏è  [2/6] Pomijanie konfiguracji backendu..."
        echo "‚è≠Ô∏è  [3/6] Pomijanie aktualizacji backendu..."
        echo ""
    fi

    # Deployment frontendu
    if [ "$DEPLOY_FRONTEND" = true ]; then
        echo "üé® [4/6] Sprawdzanie konfiguracji frontendu..."
        cd frontend

        if [ ! -f .env.production ]; then
            echo "Tworzenie frontend/.env.production..."
            echo "VITE_API_URL=https://www.tamteklipy.pl" > .env.production
            echo "‚úÖ .env.production utworzony"
        else
            echo "‚úÖ .env.production istnieje"
        fi

        # Sprawd≈∫ czy dist istnieje (powinien byƒá przes≈Çany z Windows)
        if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  OSTRZE≈ªENIE: dist/ jest pusty lub nie istnieje!"
            echo "   Frontend powinien byƒá zbudowany na Windows i przes≈Çany przez SCP"
        else
            echo "‚úÖ dist/ istnieje i zawiera pliki"
        fi
        echo ""

        cd ..
    else
        echo "‚è≠Ô∏è  [4/6] Pomijanie konfiguracji frontendu..."
        echo ""
    fi

    # Restart serwisu frontendu
    if [ "$DEPLOY_FRONTEND" = true ]; then
        echo "üîÑ [5/6] Restartowanie serwisu frontendu..."
        sudo systemctl restart tamteklipy-frontend
        echo "‚úÖ Frontend zrestartowany"
        echo ""
    else
        echo "‚è≠Ô∏è  [5/6] Pomijanie restartu frontendu..."
        echo ""
    fi

    # Sprawdzenie zdrowia systemu
    echo "üè• [6/6] Sprawdzanie zdrowia systemu..."

    sleep 2  # Daj serwisom czas na start

    if [ "$DEPLOY_BACKEND" = true ]; then
        if curl -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ Backend odpowiada"
        else
            echo "‚ö†Ô∏è  Backend jeszcze nie odpowiada (mo≈ºe potrzebowaƒá chwili)"
        fi
    fi

    if [ "$DEPLOY_FRONTEND" = true ]; then
        if [ -d "frontend/dist" ] && [ "$(ls -A frontend/dist)" ]; then
            echo "‚úÖ Frontend dist istnieje"
        else
            echo "‚ùå Frontend dist jest pusty!"
        fi
    fi

    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë   Deployment Zako≈Ñczony! üöÄ           ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "üìç Twoja aplikacja: https://www.tamteklipy.pl"
    echo "üìç Health check: https://www.tamteklipy.pl/health"
    echo ""
    echo "üîê Domy≈õlne logowanie: philornot / HasloFilipa"
    echo ""
    echo "üìã Przydatne komendy:"
    echo "   sudo systemctl status tamteklipy-backend"
    echo "   sudo systemctl status tamteklipy-frontend"
    echo "   tail -f backend/logs/tamteklipy.log"
    echo ""
fi